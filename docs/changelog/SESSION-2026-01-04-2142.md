# Session Changelog - January 4, 2026 (21:42)

## Summary

Fixed multiple issues with the waiting notification system on WSL, focusing on the permission hook for MVP.

---

## Changes Made

### 1. Default Bell Sound Updated
- Changed from `Cool_bell.wav` to `Cool_bell_final.wav`
- File: `src/waiting/cli.py` (line 50)

### 2. WSL Audio Fix
**Problem:** Windows `SoundPlayer` cannot handle WSL UNC paths (`\\wsl.localhost\...`), causing silent failures.

**Fix:** Copy audio file to Windows-accessible location before playing:
```bash
win_temp="/mnt/c/Users/Public/waiting-bell.wav"
cp "{audio_path}" "$win_temp" 2>/dev/null
powershell.exe -c "(New-Object Media.SoundPlayer 'C:\Users\Public\waiting-bell.wav').PlaySync()" 2>/dev/null &
```
- File: `src/waiting/cli.py` (lines 64-68)

### 3. Child Process Cleanup Fix
**Problem:** When nag script is killed, PowerShell child processes continue playing.

**Fix:** Added `pkill -P $$` to cleanup function in all nag scripts:
```bash
cleanup() {
    pkill -P $$ 2>/dev/null  # Kill child processes (e.g., PowerShell audio)
    rm -f "$PID_FILE"
    exit 0
}
```
- File: `src/waiting/cli.py` (lines 138-142, 263-267, 376-380)

### 4. Race Condition Fix (+2 Buffer)
**Problem:** Activity hooks use `+1` timestamp buffer, causing race conditions with nag scripts.

**Fix:** Added `+2` buffer to start_time in Stop hook (Permission hook already had this):
```bash
start_time=$(($(cat "$STOP_TIME_FILE" 2>/dev/null || date +%s) + 2))
```
- File: `src/waiting/cli.py` (line 133)

### 5. MVP Configuration: Permission Hook Only
**Change:** Disabled stop and idle hooks to focus on permission hook for MVP.

**Current config:**
```
Enabled hooks: permission
Grace periods:
  permission: 10s
```

---

## Current State

After running `waiting status`:
```
Status: enabled
Audio: default
Interval: 30s
Max nags: 0 (0=unlimited)
Volume: 100%
Enabled hooks: permission
Grace periods:
  stop: 300s
  permission: 10s
  idle: 0s
```

---

## Files Modified

| File | Changes |
|------|---------|
| `src/waiting/cli.py` | Default bell, WSL audio fix, cleanup fix, +2 buffer |
| `~/.waiting.json` | enabled_hooks: ["permission"] |
| `~/.claude/settings.json` | Only permission hook registered |

---

## Testing Checklist

- [ ] Permission dialog appears → wait 10s → bell plays
- [ ] Permission dialog appears → respond within 10s → no bell
- [ ] Bell stops immediately when user responds (no lingering sounds)
- [ ] No bells when Claude is actively working

---

## Known Issues Being Investigated

- Bells were playing unexpectedly during Claude's work (possibly permission hook firing too often)
- Need to verify the permission hook only fires on actual permission dialogs, not on auto-approved tools

---

## Commands Reference

```bash
# Enable/disable waiting
waiting              # Enable with current config
waiting disable      # Disable all hooks

# Check status
waiting status

# Kill stray processes
pkill -f "waiting-nag-"

# Clean temp files
rm -f /tmp/waiting-nag-*.pid /tmp/waiting-pending-*
```
