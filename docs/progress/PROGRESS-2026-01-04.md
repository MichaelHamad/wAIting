# Progress Check - January 4, 2026

## Summary

Rewrote the "waiting" CLI tool from scratch based on ONE_SHOT_PROMPT.md specification. Currently debugging the permission hook notification system.

## Completed

- [x] Full rewrite of `src/waiting/cli.py` (767 lines)
- [x] Implemented all 3 hook types (Stop, Permission, Idle)
- [x] Per-hook grace periods configuration
- [x] Cross-platform audio detection (paplay, pw-play, aplay, afplay, powershell.exe)
- [x] Full CLI commands (status, configure, disable, kill)
- [x] Session-specific temp files for multi-session support
- [x] Comprehensive README.md documentation
- [x] Committed rewrite to `burn-and-grow-refactor` branch

## Current Configuration

```json
{
  "enabled_hooks": ["permission"],  // Only permission hook enabled for testing
  "grace_period_permission": 10,
  "interval": 30,
  "max_nags": 0
}
```

## Issues Found & Fixed

### Issue 1: Hooks not loading after code changes
**Cause:** Claude Code only reads `~/.claude/settings.json` at startup
**Fix:** Restart Claude Code after making changes

### Issue 2: Stale processes from old implementation
**Cause:** Old nag processes and temp files from previous implementation
**Fix:** Cleaned up `/tmp/waiting-*` files and killed stray processes

### Issue 3: Bell not playing when permission dialog open
**Cause:** Race condition - `PreToolUse` fires in same second as `PermissionRequest`, sets activity timestamp to `now+1`, nag sees activity and exits immediately
**Fix:** Changed nag script to use `start_time = now + 2` to avoid race with `+1` buffer

### Issue 4: Extra bell after user approves (IN PROGRESS)
**Cause:** When user approves, `pkill` kills nag script but child `powershell.exe` process continues playing sound
**Partial Fix:** Added `pkill -f "bell.wav"` to activity hooks to kill sound process

## Debug Logging

Added debug logging to all hooks, output to `/tmp/waiting-debug.log`:
- Permission hook: logs when fired and session details
- PreToolUse hook: logs when fired
- UserPromptSubmit hook: logs when fired

## Files Modified Today

| File | Status |
|------|--------|
| `src/waiting/cli.py` | Rewritten from scratch |
| `README.md` | Updated with full documentation |
| `ISSUES.md` | Created - documents issues |
| `~/.claude/hooks/waiting-notify-permission.sh` | Added debug logging, +2 buffer fix |
| `~/.claude/hooks/waiting-activity-tooluse.sh` | Added debug logging, bell.wav pkill |
| `~/.claude/hooks/waiting-activity-submit.sh` | Added debug logging |

## Current Behavior

| Scenario | Expected | Actual |
|----------|----------|--------|
| Permission dialog opens, user AFK 10s | Bell plays | Bell plays (after +2 fix) |
| Permission dialog opens, user approves quickly | No bell | No bell |
| User approves after hearing bell | Bell stops | Sometimes extra bell plays |
| Auto-approved tools | No bell | No bell (correct) |

## Next Steps

1. Fix extra bell after approval (kill powershell.exe child process)
2. Update `cli.py` to include the +2 buffer fix in generated scripts
3. Test Stop and Idle hooks
4. Consider if UserPromptSubmit also needs the +2 buffer fix

## Commands for Testing

```bash
# Check status
waiting status

# Watch debug log
tail -f /tmp/waiting-debug.log

# Check for running nag processes
ps aux | grep "waiting-nag" | grep -v grep

# Check temp files
ls -la /tmp/waiting-*

# Kill all nag processes
pkill -f "waiting-nag"

# Test audio directly
powershell.exe -c "(New-Object Media.SoundPlayer '$(wslpath -w /home/michael/projects/waiting_new/src/waiting/bell.wav)').PlaySync()"
```

## Git Status

- Branch: `burn-and-grow-refactor`
- Last commit: `c86651e` - "Rewrite cli.py with full ONE_SHOT_PROMPT.md spec"
- Uncommitted changes: Hook scripts in `~/.claude/hooks/` (debug logging, fixes)
