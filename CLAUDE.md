# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**waiting** is a CLI tool that provides audio notifications when Claude Code needs user input. It uses Claude Code's hook system to detect when Claude is waiting and plays a sound to alert the user.

## Essential Commands

### Development Setup
```bash
# Create virtual environment
python3 -m venv venv
source venv/bin/activate

# Install in development mode
pip install -e .

# Test the CLI
waiting --help
```

### Installing and Testing
```bash
# Install from source
pip install .

# Enable notifications
waiting

# Check status
waiting status

# View/modify configuration
waiting configure --show
waiting configure --grace-stop 600

# Disable
waiting disable
```

### Building and Distribution
```bash
# Build wheel
python -m build

# The build includes bell.wav - configured in pyproject.toml [tool.hatch.build.targets.wheel]
```

## Architecture

### Hook-Based Notification System

The tool works by installing shell script hooks into `~/.claude/settings.json`. There are THREE notification hooks with different behaviors:

1. **Stop Hook** (fires when Claude finishes responding)
   - Uses "wait and see" logic: waits `grace_period_stop` (default 5 min), then checks if user was active
   - If user hasn't interacted since Stop fired → plays bell (user is AFK)
   - Generated by: `create_stop_notify_script()`
   - Script: `~/.claude/hooks/waiting-notify-stop.sh`

2. **Permission Hook** (fires when permission dialog shown)
   - Uses "immediate check" logic: checks if user was active in last `grace_period_permission` (default 10s)
   - If no recent activity → plays bell immediately
   - Generated by: `create_permission_notify_script()`
   - Script: `~/.claude/hooks/waiting-notify-permission.sh`

3. **Idle Hook** (fires after 60s of inactivity - Claude Code's built-in `idle_prompt`)
   - Backup notification for long waits
   - Minimal grace period (default 0s) since idle_prompt already has 60s delay
   - Generated by: `create_idle_notify_script()`
   - Script: `~/.claude/hooks/waiting-notify-idle.sh`

### Activity Tracking

Activity is tracked in `/tmp/waiting-activity-{stop,permission}-{session_id}` files to support:
- Grace periods (don't spam notifications if user just responded)
- Multi-terminal support (each Claude session is independent)

Two activity recording scripts:
- **UserPromptSubmit hook** → updates BOTH Stop and Permission activity files (user sent message)
- **PreToolUse hook** → updates ONLY Permission activity file (user approved permission)

This separation enables the different notification strategies:
- Stop hook: "Were you active since I finished?" (checks stop time vs activity time)
- Permission hook: "Were you active recently?" (checks now vs activity time)

### Multi-Session Support

Each Claude Code session is tracked independently using session IDs from hook context:
- PID files: `/tmp/waiting-nag-{session_id}.pid`
- Activity files: `/tmp/waiting-activity-{stop,permission}-{session_id}`
- Stop time files: `/tmp/waiting-stop-time-{session_id}`

Session ID extraction:
```bash
SESSION_ID=$(echo "$HOOK_INPUT" | grep -o '"session_id":"[^"]*"' | cut -d'"' -f4)
# Fallback to hash if session_id not found
if [ -z "$SESSION_ID" ]; then
    SESSION_ID=$(echo "$HOOK_INPUT" | md5sum | cut -c1-8)
fi
```

### Nag Loop Mechanism

All hooks can start a background nag loop that:
1. Plays sound at configured interval (default 30s)
2. Continues until user responds OR max_nags reached
3. Can be killed with `waiting kill` or automatically when user responds
4. PID tracked in `/tmp/waiting-nag-{session_id}.pid`

## Configuration

Config stored in `~/.waiting.json` (override with `WAITING_CONFIG` env var):

```json
{
  "audio": "default",
  "interval": 30,
  "max_nags": 0,
  "enabled_hooks": ["stop", "permission", "idle"],
  "grace_period_stop": 300,
  "grace_period_permission": 10,
  "grace_period_idle": 0
}
```

Configuration is managed by:
- `load_config()` - loads config with defaults for missing values
- `save_config()` - saves to `~/.waiting.json`
- `DEFAULT_CONFIG` - source of truth for default values (cli.py:12-22)

## Code Structure

### src/waiting/cli.py (main module)

Key functions organized by purpose:

**Config Management:**
- `get_config_path()` - resolve config file location
- `load_config()` / `save_config()` - config file I/O

**Claude Settings Integration:**
- `get_claude_settings_path()` - returns `~/.claude/settings.json`
- `load_claude_settings()` / `save_claude_settings()` - Claude config I/O
- `get_hooks_dir()` - returns `~/.claude/hooks/`

**Hook Script Generation:**
- `create_stop_notify_script()` - "wait and see" logic for Stop hook
- `create_permission_notify_script()` - "immediate check" logic for Permission hook
- `create_idle_notify_script()` - backup notification for idle_prompt
- `create_activity_scripts()` - generates UserPromptSubmit and PreToolUse scripts

**Hook Installation:**
- `setup_hooks()` - adds hook entries to Claude settings.json
- `remove_hook()` - removes all waiting hooks
- `_is_waiting_hook()` - identifies our hooks by command path

**Process Management:**
- `_kill_nag_process()` - terminates running nag loops

**CLI Commands:**
- `cli()` - main entry point, enables with config
- `disable()` - removes hooks and scripts
- `kill()` - stops nag loop without disabling
- `status()` - shows current configuration
- `configure()` - modify config settings

### src/waiting/__init__.py
Empty module file.

### bell.wav
Bundled notification sound, included in wheel via `pyproject.toml` artifacts config.

## Important Implementation Details

### Grace Period Logic Differences

**Stop Hook** (cli.py:92-223):
```bash
# Records Stop time
stop_time=$(date +%s)
echo "$stop_time" > "$STOP_TIME_FILE"

# Background process waits grace_period, then checks
sleep "$GRACE_PERIOD"
last_activity=$(cat "$ACTIVITY_FILE" 2>/dev/null || echo 0)
if [ "$last_activity" -gt "$stop_time" ]; then
    exit 0  # User was active after Stop
fi
# User AFK - play sound
```

**Permission Hook** (cli.py:225-337):
```bash
# Checks if user was active recently (lookback window)
if [ "$GRACE_PERIOD" -gt 0 ] && [ -f "$ACTIVITY_FILE" ]; then
    last_activity=$(cat "$ACTIVITY_FILE")
    now=$(date +%s)
    elapsed=$((now - last_activity))
    if [ "$elapsed" -lt "$GRACE_PERIOD" ]; then
        exit 0  # User was active recently
    fi
fi
# No recent activity - play sound immediately
```

### Cross-Platform Audio Detection

Scripts auto-detect available audio players (cli.py:152-168 and similar blocks):
```bash
play_sound() {
    if command -v aplay &> /dev/null; then
        aplay -q "{audio_path}" 2>/dev/null
    elif command -v paplay &> /dev/null; then
        paplay "{audio_path}" 2>/dev/null
    elif command -v pw-play &> /dev/null; then
        pw-play "{audio_path}" 2>/dev/null
    elif command -v afplay &> /dev/null; then
        afplay "{audio_path}" 2>/dev/null
    elif command -v powershell.exe &> /dev/null; then
        # WSL: convert to Windows path and play via PowerShell
        win_path=$(wslpath -w "{audio_path}" 2>/dev/null)
        powershell.exe -c "(New-Object Media.SoundPlayer '$win_path').PlaySync()"
    fi
}
```

### Hook Cleanup

When disabling, we remove hooks from all types including legacy ones (cli.py:668-690):
- Current: Stop, Notification, UserPromptSubmit, PermissionRequest, PreToolUse
- Legacy: PostToolUse (from older versions)

The `_is_waiting_hook()` function identifies our hooks by checking if command contains:
- `waiting-notify`
- `waiting-stop`
- `waiting-activity`

### Multi-Session Cleanup

`_kill_nag_process()` handles both new and legacy formats (cli.py:809-872):
- Kills all session-specific nag processes (`/tmp/waiting-nag-*.pid`)
- Updates all activity files with current timestamp
- Cleans up stop-time files
- Handles legacy single-PID-file format for backwards compatibility

## Development Patterns

### Adding a New Configuration Option

1. Add to `DEFAULT_CONFIG` dict (cli.py:12-22)
2. Update `configure()` command with new option (cli.py:940+)
3. Pass to appropriate script generation function
4. Update shell script template to use the value
5. Update `status()` command to display it (cli.py:875-938)

### Modifying Hook Behavior

All hook scripts are generated from Python f-strings in `create_*_script()` functions. To modify:

1. Edit the script template in the appropriate function
2. Test by running `waiting` to regenerate scripts
3. Check generated script in `~/.claude/hooks/`
4. Verify in `~/.claude/settings.json`

### Testing Hook Scripts

```bash
# Enable waiting
waiting

# View generated scripts
cat ~/.claude/hooks/waiting-notify-stop.sh
cat ~/.claude/hooks/waiting-notify-permission.sh
cat ~/.claude/hooks/waiting-activity-submit.sh

# Check Claude settings
cat ~/.claude/settings.json | jq '.hooks'

# Manually trigger a script to test
echo '{"session_id":"test123"}' | ~/.claude/hooks/waiting-notify-permission.sh

# Check activity files
cat /tmp/waiting-activity-permission-test123
cat /tmp/waiting-nag-test123.pid

# Kill test nag loop
waiting kill
```

## Notes on Hook Integration

- Hooks execute shell commands and receive JSON context via stdin
- Hooks have a `timeout` field (we use 5-10s) - must complete within timeout
- Hook commands must be executable (we chmod +x generated scripts)
- Hooks are cached at Claude Code startup - users must restart Claude after changes
- Empty matcher `""` means hook fires for all events of that type
- The `idle_prompt` matcher is a specific notification type with 60s built-in delay
